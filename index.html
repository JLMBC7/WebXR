<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Dumpster Fire AR</title>
    <!-- Include A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .ui-overlay {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: sans-serif;
            text-align: center;
            pointer-events: none;
            width: 80%;
            max-width: 300px;
        }
        /* iOS often requires a user gesture to start video/audio */
        #start-button {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            padding: 20px;
            background: #ff6600;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    
    <button id="start-button">Start AR Experience</button>

    <div class="ui-overlay">
        Point camera at a <b>Hiro Marker</b><br>
        <small>Optimized for iOS Safari</small>
    </div>

    <!-- 
        iOS Specific Fixes:
        1. 'videoTexture: true' helps with some iOS rendering bugs
        2. 'sourceType: webcam' combined with the button trigger ensures permissions
    -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" 
        renderer="antialias: true; alpha: true; colorManagement: true; logarithmicDepthBuffer: true;">
        
        <!-- Assets Management -->
        <a-assets>
            <a-asset-item id="dumpster-model" src="/DumpsterFire.glb"></a-asset-item>
        </a-assets>

        <!-- AR Marker Handler -->
        <a-marker type="pattern" url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/data/patt.hiro">
            
            <a-entity 
                id="dumpster-container" 
                position="0 0 0" 
                scale="1 1 1">
                
                <a-entity 
                    gltf-model="#dumpster-model" 
                    position="0 0 0"
                    rotation="0 0 0"
                    scale="0.5 0.5 0.5">
                </a-entity>
                
                <a-entity id="fire-container" position="0 0.2 0" fire-system></a-entity>
                
                <a-light type="point" color="#ff6600" intensity="2" distance="2"
                         animation="property: intensity; from: 1; to: 2.5; dir: alternate; dur: 120; loop: true">
                </a-light>
            </a-entity>

        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // iOS Safari Permission Handling
        document.getElementById('start-button').addEventListener('click', function() {
            this.style.display = 'none';
            // Explicitly resume audio context or video if needed
            const scene = document.querySelector('a-scene');
            if (scene.hasLoaded) {
                scene.play();
            }
        });

        // Enhanced Fire System for GLB integration
        AFRAME.registerComponent('fire-system', {
            init: function () {
                this.particles = [];
                this.particleCount = 35;
                
                for (let i = 0; i < this.particleCount; i++) {
                    this.createParticle();
                }
            },

            createParticle: function () {
                const p = document.createElement('a-entity');
                
                const size = Math.random() * 0.25 + 0.15;
                p.setAttribute('geometry', {
                    primitive: 'plane',
                    width: size,
                    height: size
                });

                const colors = ['#ffcc00', '#ff8800', '#ff3300', '#ff5500'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                p.setAttribute('material', {
                    color: color,
                    transparent: true,
                    opacity: 0.8,
                    shader: 'flat',
                    side: 'double',
                    blending: 'additive'
                });

                const x = (Math.random() - 0.5) * 0.4;
                const z = (Math.random() - 0.5) * 0.4;
                p.setAttribute('position', { x: x, y: 0, z: z });
                
                this.particles.push({
                    el: p,
                    speed: Math.random() * 0.015 + 0.005,
                    life: Math.random(),
                    drift: (Math.random() - 0.5) * 0.005
                });

                this.el.appendChild(p);
            },

            tick: function (time, timeDelta) {
                this.particles.forEach(p => {
                    let pos = p.el.getAttribute('position');
                    
                    pos.y += p.speed;
                    pos.x += p.drift;
                    
                    p.life -= 0.02;
                    p.el.setAttribute('material', 'opacity', p.life);
                    
                    if (p.life <= 0 || pos.y > 0.8) {
                        pos.y = 0;
                        pos.x = (Math.random() - 0.5) * 0.4;
                        pos.z = (Math.random() - 0.5) * 0.4;
                        p.life = 1.0;
                    }
                    
                    p.el.setAttribute('position', pos);
                    p.el.object3D.lookAt(0, pos.y, 0);
                });
            }
        });
    </script>
</body>
</html>