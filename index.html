<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Dumpster Placement</title>
    
    <!-- 1. VARIANT LAUNCH SDK -->
    <script src="https://launchar.app/sdk/v1?key=K3ApwHjOT76Mh2KryCttLoMOgPY6dOFK&redirect=true"></script>

    <!-- 2. BABYLON.JS CORE & LOADERS -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

    <style>
        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            font-family: -apple-system, system-ui, sans-serif;
        }

        #renderCanvas { width: 100%; height: 100%; touch-action: none; }

        #ui-overlay {
            position: absolute; top: 20px; left: 0; right: 0;
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
        }

        .status-badge {
            background: rgba(0, 0, 0, 0.8);
            color: white; padding: 12px 24px; border-radius: 30px;
            font-size: 14px; backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            text-align: center;
        }

        /* Prominent Button to trigger session */
        .ar-button {
            display: none; position: absolute; bottom: 50px;
            left: 50%; transform: translateX(-50%);
            background: #007AFF; color: #fff;
            padding: 20px 40px; border-radius: 50px;
            font-weight: bold; text-decoration: none;
            font-size: 18px; box-shadow: 0 10px 25px rgba(0,122,255,0.4);
            pointer-events: auto; z-index: 100;
            border: none; cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <div id="status" class="status-badge">Detecting AR Capabilities...</div>
    </div>

    <!-- UI Buttons for different platforms -->
    <a id="ios-prompt" class="ar-button" href="#">START AR (iOS)</a>
    <button id="android-prompt" class="ar-button">ENTER AR</button>
    
    <canvas id="renderCanvas"></canvas>

    <script>
        const canvas = document.getElementById("renderCanvas");
        const statusEl = document.getElementById("status");
        const iosPrompt = document.getElementById("ios-prompt");
        const androidPrompt = document.getElementById("android-prompt");
        
        let engine, scene, xrHelper, hitTestResult, dumpsterRoot;
        const DUMPSTER_URL = "https://raw.githubusercontent.com/JLMBC7/WebXR/e76019e5a71c79b4f9dd8f3c72a40e64feec1cdc/DirtyDumpster.glb";

        const initApp = async () => {
            engine = new BABYLON.Engine(canvas, true);
            scene = new BABYLON.Scene(engine);

            // Default Camera to prevent render error
            const camera = new BABYLON.FreeCamera("defaultCamera", new BABYLON.Vector3(0, 5, -10), scene);
            camera.setTarget(BABYLON.Vector3.Zero());
            
            new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

            try {
                const result = await BABYLON.SceneLoader.ImportMeshAsync("", "", DUMPSTER_URL, scene);
                dumpsterRoot = result.meshes[0];
                dumpsterRoot.scaling = new BABYLON.Vector3(0.5, 0.5, 0.5);
                dumpsterRoot.setEnabled(false); 
                statusEl.innerText = "Dumpster Loaded. Checking AR...";
            } catch (err) {
                statusEl.innerText = "Error loading model. Check connection.";
            }

            // --- VARIANT LAUNCH HANDLER ---
            const handleVLaunch = (e) => {
                const { launchRequired, launchUrl } = e.detail;
                if (launchRequired) {
                    // iOS logic
                    statusEl.innerText = "iOS Detected. Tap button below.";
                    iosPrompt.style.display = "block";
                    iosPrompt.href = launchUrl;
                } else {
                    // Android / Native logic
                    checkNativeWebXR();
                }
            };

            window.addEventListener('vlaunch-initialized', handleVLaunch);
            
            // Fallback: If event fired before listener was attached
            if (window.VLaunch && window.VLaunch.isInitialized) {
                handleVLaunch({ detail: window.VLaunch });
            }

            engine.runRenderLoop(() => {
                if (scene.activeCamera) scene.render();
            });
        };

        const checkNativeWebXR = async () => {
            const supported = await BABYLON.WebXRSessionManager.IsSessionSupportedAsync("immersive-ar");
            if (supported) {
                statusEl.innerText = "AR Supported. Click to start.";
                androidPrompt.style.display = "block";
                androidPrompt.onclick = () => setupWebXR();
            } else {
                statusEl.innerText = "WebXR AR not supported on this browser.";
            }
        };

        const setupWebXR = async () => {
            androidPrompt.style.display = "none";
            try {
                xrHelper = await scene.createDefaultXRExperienceAsync({
                    uiOptions: {
                        sessionMode: "immersive-ar",
                        referenceSpaceType: "local-floor"
                    },
                    optionalFeatures: ["hit-test", "anchors"]
                });

                const fm = xrHelper.baseExperience.featuresManager;
                const xrHitTest = fm.enableFeature(BABYLON.WebXRFeatureName.HIT_TEST, "latest");
                
                // Placement Reticle
                const reticle = BABYLON.MeshBuilder.CreateTorus("reticle", {
                    diameter: 0.25, thickness: 0.03
                }, scene);
                reticle.isVisible = false;
                const reticleMat = new BABYLON.StandardMaterial("reticleMat", scene);
                reticleMat.emissiveColor = new BABYLON.Color3(0, 1, 0);
                reticle.material = reticleMat;

                xrHitTest.onHitTestResultObservable.add((results) => {
                    if (results.length) {
                        reticle.isVisible = true;
                        hitTestResult = results[0];
                        hitTestResult.transformationMatrix.decompose(undefined, reticle.rotationQuaternion, reticle.position);
                    } else {
                        reticle.isVisible = false;
                    }
                });

                xrHelper.baseExperience.sessionManager.onXRSessionInit.add(() => {
                    statusEl.innerText = "Move phone to scan for a floor";
                });

                scene.onPointerDown = () => {
                    if (xrHelper.baseExperience.state === BABYLON.WebXRState.IN_XR && hitTestResult && dumpsterRoot) {
                        const placed = dumpsterRoot.instantiateHierarchy();
                        placed.setEnabled(true);
                        hitTestResult.transformationMatrix.decompose(undefined, placed.rotationQuaternion, placed.position);
                        statusEl.innerText = "Dumpster Placed!";
                    }
                };
            } catch (e) {
                statusEl.innerText = "Failed to start AR session.";
            }
        };

        window.onload = initApp;
        window.addEventListener("resize", () => engine?.resize());
    </script>
</body>
</html>
