<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babylon.js Fire AR</title>
    <!-- Babylon.js Core and Loaders -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <style>
        body { margin: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: sans-serif; }
        canvas { width: 100%; height: 100%; touch-action: none; outline: none; }
        
        #overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            color: white;
            cursor: pointer;
            text-align: center;
            padding: 20px;
        }
        .btn {
            background: #4285f4;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            margin-bottom: 10px;
        }
        .error-msg {
            color: #ff4444;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <button class="btn" id="startBtn">Launch Experience</button>
        <p id="instructionText">Tap to start (AR mode requires a compatible mobile device)</p>
        <div id="error-msg" class="error-msg">WebXR AR not supported. Loading 3D viewer instead...</div>
    </div>

    <canvas id="renderCanvas"></canvas>

    <script>
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        const destinationUrl = "https://www.google.com";
        const modelUrl = "https://raw.githubusercontent.com/JLMBC7/WebXR/a7b59956486303c358bbb380bcaa992c8f084910/DirtyDumpster.glb";

        const createScene = async function () {
            const scene = new BABYLON.Scene(engine);
            
            // Camera for non-AR viewing
            const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 2.5, 5, new BABYLON.Vector3(0, 0.5, 0), scene);
            camera.lowerRadiusLimit = 2;
            camera.upperRadiusLimit = 10;
            camera.attachControl(canvas, true);
            
            // Lighting
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;

            // Load the Dumpster
            try {
                const result = await BABYLON.SceneLoader.ImportMeshAsync("", "", modelUrl, scene);
                const dumpster = result.meshes[0];
                dumpster.scaling = new BABYLON.Vector3(0.5, 0.5, 0.5);
                dumpster.position = new BABYLON.Vector3(0, 0, 0);
            } catch (err) {
                console.error("Failed to load model:", err);
            }

            // FIRE PARTICLE SYSTEM
            const fireSystem = new BABYLON.ParticleSystem("particles", 2000, scene);
            fireSystem.particleTexture = new BABYLON.Texture("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJS-Assets/master/Particles/Fire/Flare.png", scene);

            // Emitter inside dumpster
            fireSystem.emitter = new BABYLON.Vector3(0, 0.5, 0); 
            fireSystem.minEmitBox = new BABYLON.Vector3(-0.3, 0, -0.2);
            fireSystem.maxEmitBox = new BABYLON.Vector3(0.3, 0.1, 0.2);

            fireSystem.color1 = new BABYLON.Color4(1, 0.5, 0, 1.0);
            fireSystem.color2 = new BABYLON.Color4(1, 0.2, 0, 1.0);
            fireSystem.colorDead = new BABYLON.Color4(0, 0, 0, 0.0);

            fireSystem.minSize = 0.1;
            fireSystem.maxSize = 0.5;
            fireSystem.minLifeTime = 0.2;
            fireSystem.maxLifeTime = 0.7;
            fireSystem.emitRate = 600;
            fireSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;
            fireSystem.gravity = new BABYLON.Vector3(0, 9.81, 0);
            fireSystem.direction1 = new BABYLON.Vector3(-0.5, 2, -0.5);
            fireSystem.direction2 = new BABYLON.Vector3(0.5, 2, 0.5);
            fireSystem.minEmitPower = 1;
            fireSystem.maxEmitPower = 3;
            fireSystem.updateSpeed = 0.005;

            fireSystem.start();

            // Flickering Light
            const fireLight = new BABYLON.PointLight("fireLight", new BABYLON.Vector3(0, 0.8, 0), scene);
            fireLight.diffuse = new BABYLON.Color3(1, 0.4, 0);
            fireLight.intensity = 1.5;

            scene.registerBeforeRender(() => {
                fireLight.intensity = 1.2 + Math.random() * 0.5;
            });

            // Interaction
            scene.onPointerDown = (evt, pickResult) => {
                if (pickResult.hit) {
                    window.location.href = destinationUrl;
                }
            };

            return scene;
        };

        (async function init() {
            const scene = await createScene();

            const startBtn = document.getElementById("startBtn");
            const overlay = document.getElementById("overlay");
            const errorMsg = document.getElementById("error-msg");

            startBtn.addEventListener("click", async () => {
                // Check if WebXR is supported
                const isSupported = await BABYLON.WebXRSessionManager.IsSessionSupportedAsync('immersive-ar');
                
                if (isSupported) {
                    try {
                        const xr = await scene.createDefaultXRExperienceAsync({
                            uiOptions: { sessionMode: 'immersive-ar' }
                        });
                        overlay.style.display = "none";
                    } catch (e) {
                        console.error("XR Init Failed", e);
                        overlay.style.display = "none";
                    }
                } else {
                    // Fallback: Just hide overlay and show 3D scene
                    errorMsg.style.display = "block";
                    setTimeout(() => {
                        overlay.style.display = "none";
                    }, 2000);
                }
            });

            engine.runRenderLoop(() => {
                scene.render();
            });

            window.addEventListener("resize", () => {
                engine.resize();
            });
        })();
    </script>
</body>
</html>